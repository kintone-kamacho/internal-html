<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSVå‡¦ç†ãƒ„ãƒ¼ãƒ«</title>
    <link rel="icon" href="./assets/icons/matoryoshika.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
  <script>
    // Shift-JISå¤‰æ›é–¢æ•°
    function convertToShiftJIS(str) {
      const unicodeArray = [];
      for (let i = 0; i < str.length; i++) {
        unicodeArray.push(str.charCodeAt(i));
      }
      const sjisArray = Encoding.convert(unicodeArray, {
        to: 'SJIS',
        from: 'UNICODE'
      });
      return new Uint8Array(sjisArray);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }
    .file-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
    }
    .file-section h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
    .drop-area {
      border: 3px dashed #ccc;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }
    .drop-area:hover {
      border-color: #667eea;
      background: #f0f0ff;
    }
    .drop-area.highlight {
      border-color: #667eea;
      background: #e8f0fe;
      transform: scale(1.02);
    }
    .drop-area.loaded {
      border-color: #28a745;
      background: #e8f5e9;
    }
    .file-input {
      display: none;
    }
    .btn {
      display: inline-block;
      padding: 12px 30px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    .btn-process {
      display: block;
      width: 100%;
      padding: 15px;
      background: #28a745;
      margin-top: 30px;
      font-size: 18px;
    }
    .btn-process:hover {
      background: #218838;
    }
    .btn-process:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    #progress {
      display: none;
      margin: 30px 0;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    #status {
      margin-top: 15px;
      text-align: center;
      color: #666;
      font-size: 14px;
    }
    #downloads {
      margin-top: 30px;
    }
    .download-btn {
      display: block;
      margin: 10px 0;
      padding: 15px 25px;
      background: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s;
    }
    .download-btn:hover {
      background: #218838;
      transform: translateX(5px);
    }
    .info {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #2196F3;
    }
    .info h3 {
      color: #2196F3;
      margin-bottom: 10px;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #c62828;
    }
    .success-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    .file-info {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š å“ç›®ãƒã‚¹ã‚¿ãƒ¼CSVå‡¦ç†ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="info">
      <h3>å‡¦ç†å†…å®¹</h3>
      <ul style="margin-left: 20px; line-height: 1.8;">
        <li>æŒ‡å®šã—ãŸå“ç›®ã‚³ãƒ¼ãƒ‰ã§å§‹ã¾ã‚‹è¡Œã®ã¿æŠ½å‡º</li>
        <li>å¿…è¦ãªåˆ—ï¼ˆå“ç›®ã€å“åã€ä»•æ§˜ã€ãƒ¡ãƒ¼ã‚«ãƒ¼åã€æ‰‹é…å…ˆåã€åœ¨åº«è©•ä¾¡å˜ä¾¡ã€å˜ä½ã€ä¿ç®¡å ´æ‰€ï¼‰ã‚’å–å¾—</li>
        <li>ãƒ‡ãƒ¼ã‚¿ã‚’3ç­‰åˆ†ã—ã¦CSVå‡ºåŠ›</li>
      </ul>
    </div>
    
    <div class="file-section">
      <h3>â‘  å“ç›®ãƒªã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« (.txt)</h3>
      <div class="drop-area" id="dropArea1">
        <p style="margin-bottom: 15px;">ğŸ“„ å“ç›®ãƒªã‚¹ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
        <p style="color: #999; margin-bottom: 15px; font-size: 14px;">ä¾‹: PDA, PDC, PMA, PMC...</p>
        <button class="btn" onclick="document.getElementById('fileInput1').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        <div class="file-info" id="fileInfo1"></div>
      </div>
      <input type="file" id="fileInput1" class="file-input" accept=".txt" />
    </div>
    
    <div class="file-section">
      <h3>â‘¡ CSVãƒ•ã‚¡ã‚¤ãƒ«</h3>
      <div class="drop-area" id="dropArea2">
        <p style="margin-bottom: 15px;">ğŸ“ å“ç›®ãƒã‚¹ã‚¿ãƒ¼ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
        <button class="btn" onclick="document.getElementById('fileInput2').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        <div class="file-info" id="fileInfo2"></div>
      </div>
      <input type="file" id="fileInput2" class="file-input" accept=".csv" />
    </div>
    
    <button class="btn btn-process" id="processBtn" disabled>ğŸš€ å‡¦ç†é–‹å§‹</button>
    
    <div id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div id="status">æº–å‚™ä¸­...</div>
    </div>
    
    <div id="downloads"></div>
  </div>

  <script>
    let prefixList = null;
    let csvFile = null;
    
    const dropArea1 = document.getElementById('dropArea1');
    const dropArea2 = document.getElementById('dropArea2');
    const fileInput1 = document.getElementById('fileInput1');
    const fileInput2 = document.getElementById('fileInput2');
    const fileInfo1 = document.getElementById('fileInfo1');
    const fileInfo2 = document.getElementById('fileInfo2');
    const processBtn = document.getElementById('processBtn');
    const progressDiv = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const statusDiv = document.getElementById('status');
    const downloadsDiv = document.getElementById('downloads');
    
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
    function setupDropArea(dropArea, fileInput, handler) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, e => {
          e.preventDefault();
          e.stopPropagation();
        });
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'));
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'));
      });
      
      dropArea.addEventListener('drop', e => handler(e.dataTransfer.files));
      fileInput.addEventListener('change', e => handler(e.target.files));
    }
    
    setupDropArea(dropArea1, fileInput1, handlePrefixFile);
    setupDropArea(dropArea2, fileInput2, handleCSVFile);
    
    async function handlePrefixFile(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      if (!file.name.endsWith('.txt')) {
        showError('ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(.txt)ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      try {
        const text = await file.text();
        // æ”¹è¡Œã§åˆ†å‰²ã—ã¦ç©ºè¡Œã¨ç©ºç™½ã‚’é™¤å»
        prefixList = text.split('\n')
          .map(line => line.trim())
          .filter(line => line && !line.startsWith('ã€'));
        
        dropArea1.classList.add('loaded');
        fileInfo1.innerHTML = `<span class="success-badge">âœ“ ${prefixList.length}ä»¶ã®å“ç›®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿</span>`;
        checkReady();
      } catch (error) {
        showError('å“ç›®ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    function handleCSVFile(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      if (!file.name.endsWith('.csv')) {
        showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      csvFile = file;
      dropArea2.classList.add('loaded');
      fileInfo2.innerHTML = `<span class="success-badge">âœ“ ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)</span>`;
      checkReady();
    }
    
    function checkReady() {
      if (prefixList && csvFile) {
        processBtn.disabled = false;
      }
    }
    
    processBtn.addEventListener('click', processFiles);
    
    function updateProgress(percent, message) {
      progressFill.style.width = percent + '%';
      progressFill.textContent = Math.round(percent) + '%';
      statusDiv.textContent = message;
    }
    
    async function processFiles() {
      processBtn.disabled = true;
      progressDiv.style.display = 'block';
      downloadsDiv.innerHTML = '';
      updateProgress(0, 'ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');
      
      try {
        const text = await csvFile.text();
        updateProgress(20, 'CSVè§£æä¸­...');
        
        const lines = text.split('\n');
        updateProgress(30, `${lines.length.toLocaleString()}è¡Œã‚’æ¤œå‡º...`);
        
        // å¿…è¦ãªåˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        const columnIndexes = [0, 1, 2, 3, 6, 21, 24, 45]; // A,B,C,D,G,V,Y,AT
        const newHeaders = ['å“ç›®', 'å“å', 'ä»•æ§˜', 'ãƒ¡ãƒ¼ã‚«ãƒ¼å', 'æ‰‹é…å…ˆå', 'åœ¨åº«è©•ä¾¡å˜ä¾¡', 'å˜ä½', 'ä¿ç®¡å ´æ‰€'];
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨æŠ½å‡º
        updateProgress(40, 'ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...');
        const filteredData = [];
        
        for (let i = 1; i < lines.length; i++) {
          if (i % 10000 === 0) {
            updateProgress(40 + (i / lines.length * 30), `å‡¦ç†ä¸­: ${i.toLocaleString()} / ${lines.length.toLocaleString()}è¡Œ`);
            await new Promise(resolve => setTimeout(resolve, 0));
          }
          
          const line = lines[i].trim();
          if (!line) continue;
          
          const cells = parseCSVLine(line);
          if (cells.length > 0) {
            const firstCell = cells[0].trim();
            // å“ç›®ãƒªã‚¹ãƒˆã®ã„ãšã‚Œã‹ã§å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const matchesPrefix = prefixList.some(prefix => firstCell.startsWith(prefix));
            
            if (matchesPrefix) {
              const row = columnIndexes.map(idx => cells[idx] || '');
              filteredData.push(row);
            }
          }
        }
        
        updateProgress(70, `${filteredData.length.toLocaleString()}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºå®Œäº†`);
        
        if (filteredData.length === 0) {
          showError('æŒ‡å®šã•ã‚ŒãŸå“ç›®ã‚³ãƒ¼ãƒ‰ã§å§‹ã¾ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
          processBtn.disabled = false;
          return;
        }
        
        // 3ç­‰åˆ†
        const totalRows = filteredData.length;
        const chunkSize = Math.ceil(totalRows / 3);
        
        updateProgress(80, 'CSVãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­...');
        
        for (let i = 0; i < 3; i++) {
          const start = i * chunkSize;
          const end = Math.min(start + chunkSize, totalRows);
          const chunk = filteredData.slice(start, end);
          
          // CSVç”Ÿæˆ
          const csvLines = [newHeaders.map(escapeCSV).join(',')];
          for (const row of chunk) {
            csvLines.push(row.map(escapeCSV).join(','));
          }
          const csvContent = csvLines.join('\n');
          
          // Shift-JISã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ä½œæˆ
          let blob;
          try {
            const sjisArray = convertToShiftJIS(csvContent);
            blob = new Blob([sjisArray], { type: 'text/csv;charset=shift_jis;' });
          } catch (e) {
            // å¤‰æ›å¤±æ•—æ™‚ã¯UTF-8 BOMä»˜ãã§å‡ºåŠ›
            console.error('Shift-JISå¤‰æ›ã‚¨ãƒ©ãƒ¼:', e);
            blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
          }
          
          const url = URL.createObjectURL(blob);
          const fileName = `å“ç›®ãƒã‚¹ã‚¿ãƒ¼_${String(i + 1).padStart(3, '0')}.csv`;
          
          const link = document.createElement('a');
          link.href = url;
          link.download = fileName;
          link.className = 'download-btn';
          link.textContent = `ğŸ“¥ ${fileName} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (${chunk.length.toLocaleString()}ä»¶)`;
          downloadsDiv.appendChild(link);
          
          updateProgress(80 + (i + 1) / 3 * 20, `ãƒ•ã‚¡ã‚¤ãƒ«${i + 1}/3 ç”Ÿæˆå®Œäº†`);
        }
        
        updateProgress(100, `âœ… å®Œäº†: ${totalRows.toLocaleString()}ä»¶ã‚’3ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²`);
        processBtn.disabled = false;
        
      } catch (error) {
        showError('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        processBtn.disabled = false;
      }
    }
    
    function parseCSVLine(line) {
      const result = [];
      let cell = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            cell += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(cell);
          cell = '';
        } else {
          cell += char;
        }
      }
      result.push(cell);
      return result;
    }
    
    function escapeCSV(cell) {
      let str = String(cell);
      
      // æ•°å€¤ã®ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã‚’é™¤å»ï¼ˆä¾‹: "1,234.56" â†’ "1234.56"ï¼‰
      if (/^[\d,]+\.?\d*$/.test(str)) {
        str = str.replace(/,/g, '');
      }
      
      if (str.includes(',') || str.includes('\n') || str.includes('"')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }
    
    function showError(message) {
      progressDiv.style.display = 'none';
      downloadsDiv.innerHTML = `<div class="error">${message}</div>`;
    }
  </script>
</body>
</html>
