<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»®å…¥åº«ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="icon" href="../assets/icons/daruma.png" type="image/png">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin: 40px;
      background: #f7f7f7;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      margin-top: 0;
      color: #333;
    }

    .note {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #856404;
    }

    #dropZone {
      border: 2px dashed #aaa;
      border-radius: 6px;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      color: #999;
      cursor: pointer;
      transition: all 0.3s;
    }

    #dropZone.hover {
      border-color: #0366d6;
      background: #f0f8ff;
      color: #0366d6;
    }

    #dropZone.has-file {
      border-color: #28a745;
      background: #f0fff4;
      color: #28a745;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }

    input[type="date"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #0366d6;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #0256c4;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      display: none;
    }

    #message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    #message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    #message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .stats {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š ä»®å…¥åº«ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="note">
      <strong>æŠ½å‡ºæ¡ä»¶:</strong><br>
      â€¢ å·¥ç•ª: å…ˆé ­2æ–‡å­—ã«ã€ŒKã€ã‚’å«ã¾ãªã„ã‚‚ã®<br>
      â€¢ æœŸé–“: æŒ‡å®šã—ãŸé–‹å§‹æ—¥ã€œçµ‚äº†æ—¥ã®ç¯„å›²å†…ï¼ˆç´æœŸã¾ãŸã¯å›ç­”ç´æœŸï¼‰
    </div>

    <div id="dropZone">
      ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>
      <small>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</small>
    </div>
    <input type="file" id="fileInput" accept=".csv" style="display:none">

    <div class="form-group">
      <label for="startDate">é–‹å§‹æ—¥:</label>
      <input type="date" id="startDate" required>
    </div>

    <div class="form-group">
      <label for="endDate">çµ‚äº†æ—¥:</label>
      <input type="date" id="endDate" required>
    </div>

    <button id="processBtn" onclick="processFile()">æŠ½å‡ºã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

    <div id="message"></div>
  </div>

  <script>
    let fileData = null;
    let fileName = '';
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const messageDiv = document.getElementById('message');

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('hover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('hover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('hover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    function handleFile(file) {
      if (!file.name.endsWith('.csv')) {
        showMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      fileName = file.name;
      const reader = new FileReader();
      
      reader.onload = (e) => {
        fileData = e.target.result;
        dropZone.classList.add('has-file');
        dropZone.innerHTML = `âœ“ ${fileName}<br><small>ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ</small>`;
        showMessage('', '');
      };

      reader.readAsText(file, 'UTF-8');
    }

    function showMessage(msg, type) {
      messageDiv.textContent = msg;
      messageDiv.className = type;
      if (!msg) messageDiv.style.display = 'none';
    }

    // BOMé™¤å»ãƒ»æ­£è¦åŒ–ãƒ»ãƒˆãƒªãƒ 
    function normalizeText(raw) {
      if (raw === undefined || raw === null) return "";
      let s = String(raw);
      s = s.replace(/^\uFEFF/, ""); // BOMé™¤å»
      if (typeof s.normalize === "function") s = s.normalize("NFKC");
      return s.trim();
    }

    // å·¥ç•ªãŒæœ‰åŠ¹ã‹ï¼ˆå…ˆé ­2æ–‡å­—ã«Kã‚’å«ã¾ãªã„ï¼‰
    function isValidKbnCode(raw) {
      const s = normalizeText(raw).toUpperCase();
      if (!s) return false;
      const prefix = s.slice(0, 2);
      return !prefix.includes("K");
    }

    // æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ï¼ˆYYYY/MM/DD ã¾ãŸã¯ YYYY-MM-DDï¼‰
    function parseDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;

      let s = normalizeText(String(value));
      const m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
      
      if (m) {
        const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
        return new Date(y, mo - 1, d);
      }

      const alt = new Date(s);
      return isNaN(alt.getTime()) ? null : alt;
    }

    // æœŸé–“åˆ¤å®š
    function isWithinPeriod(cDate, dDate, startDate, endDate) {
      if (!startDate || !endDate) return false;

      // å›ç­”ç´æœŸãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
      if (dDate instanceof Date && !isNaN(dDate.getTime())) {
        return (dDate >= startDate && dDate <= endDate);
      }

      // å›ç­”ç´æœŸãŒãªã‘ã‚Œã°ç´æœŸã‚’è¦‹ã‚‹
      if (cDate instanceof Date && !isNaN(cDate.getTime())) {
        return (cDate >= startDate && cDate <= endDate);
      }

      return false;
    }

    // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
    function parseCSV(text) {
      const lines = text.split(/\r?\n/);
      const result = [];
      
      for (let line of lines) {
        if (!line.trim()) continue;
        
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå†…ã®ã‚«ãƒ³ãƒã¯ç„¡è¦–ï¼‰
        const row = [];
        let inQuotes = false;
        let currentCell = '';
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            row.push(currentCell);
            currentCell = '';
          } else {
            currentCell += char;
          }
        }
        row.push(currentCell);
        result.push(row);
      }
      
      return result;
    }

    // CSVç”Ÿæˆ
    function generateCSV(rows) {
      return rows.map(row => {
        return row.map(cell => {
          const s = String(cell || '');
          // ã‚«ãƒ³ãƒã€æ”¹è¡Œã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’å«ã‚€å ´åˆã¯ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
          if (s.includes(',') || s.includes('\n') || s.includes('"')) {
            return '"' + s.replace(/"/g, '""') + '"';
          }
          return s;
        }).join(',');
      }).join('\n');
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadCSV(csvContent, filename) {
      const bom = '\uFEFF';
      const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ãƒ¡ã‚¤ãƒ³å‡¦ç†
    function processFile() {
      const startDateStr = document.getElementById('startDate').value;
      const endDateStr = document.getElementById('endDate').value;

      if (!fileData) {
        showMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!startDateStr || !endDateStr) {
        showMessage('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      showMessage('å‡¦ç†ä¸­...', 'info');

      try {
        // æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹
        const startDate = parseDate(startDateStr);
        const endDate = parseDate(endDateStr);

        if (!startDate || !endDate) {
          throw new Error('æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        }

        // CSV ãƒ‘ãƒ¼ã‚¹
        const csvText = normalizeText(fileData);
        const data = parseCSV(csvText);

        if (!data || data.length === 0) {
          throw new Error('CSVã®å†…å®¹ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼
        const header = data[0];
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const filtered = [];
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (row.length < 4) continue; // æœ€ä½é™ã®åˆ—æ•°ãƒã‚§ãƒƒã‚¯

          const rawA = row[0]; // å·¥ç•ª
          const codeOk = isValidKbnCode(rawA);

          const parsedC = parseDate(row[2]); // ç´æœŸ
          const parsedD = parseDate(row[3]); // å›ç­”ç´æœŸ

          const dateOk = isWithinPeriod(parsedC, parsedD, startDate, endDate);

          if (codeOk && dateOk) {
            filtered.push(row);
          }
        }

        // çµæœç”Ÿæˆ
        const resultRows = [header, ...filtered];
        const csvContent = generateCSV(resultRows);

        // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
        const today = new Date();
        const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
        const startStr = startDate.toISOString().slice(0, 10).replace(/-/g, '');
        const endStr = endDate.toISOString().slice(0, 10).replace(/-/g, '');
        const outputFileName = `æŠ½å‡ºçµæœ_${dateStr}_${startStr}_${endStr}.csv`;

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        downloadCSV(csvContent, outputFileName);

        showMessage(
          `âœ“ æŠ½å‡ºå®Œäº†\nç·è¡Œæ•°: ${data.length - 1}è¡Œ\næŠ½å‡ºè¡Œæ•°: ${filtered.length}è¡Œ\nãƒ•ã‚¡ã‚¤ãƒ«å: ${outputFileName}`,
          'success'
        );

      } catch (error) {
        showMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        console.error(error);
      }
    }
  </script>
</body>
</html>
